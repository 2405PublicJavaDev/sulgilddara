<!DOCTYPE html>
<html xmlns:th="http://thymeleaf.org" >
	<head>
		<meta charset="UTF-8">
		<title>게시글 작성</title>
		<!-- include libraries(jQuery, bootstrap) -->
		<link href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" rel="stylesheet">
		<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
		
		<!-- include summernote css/js -->
		<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.css" rel="stylesheet">
		<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.js"></script>
	
		<!-- 태그 라이브러리 다운-->
		<!-- 소스 다운 -->
		<script src="https://unpkg.com/@yaireo/tagify"></script>
		<!-- 폴리필 (구버젼 브라우저 지원) -->
		<script src="https://unpkg.com/@yaireo/tagify/dist/tagify.polyfills.min.js"></script>
		<link href="https://unpkg.com/@yaireo/tagify/dist/tagify.css" rel="stylesheet" type="text/css" />	
		
		
		
		<!-- font-awsome -->
		<script src="https://kit.fontawesome.com/7d4169cb69.js" crossorigin="anonymous"></script>
		
		<!-- css파일들 -->
		<link rel="stylesheet" href="/css/boardWritePage.css">
		<link rel="stylesheet" href="/css/liquorSelectModal.css">
		
	</head>
	<body>
		<h1>게시글 수정</h1>
		
		<form action="/board/modify" method="post" enctype="multipart/form-data">
		<input type="hidden" name="boardNo" th:value="${board.boardNo}">
			제목 <input type="text" name="boardSubject" th:value="${board.boardSubject}"> <br>
			<div id="liquorSelectBox">
				[[${board.liquorId}]]
			</div>
			<div id="modalWrap"> <!-- 모달 창을 감싸는 div -->
		      <div id="modalBody">
		        <span id="closeBtn">&times;</span> <!-- 모달을 닫는 X 버튼 -->
		        
		        <div id="liquorSearchBox">
					<div>
						<input type="text" name="" placeholder="검색어를 입력해주세요">
						<button type="button" onclick="searchLiquor();">검색</button>
					</div>
		        </div>
		      </div>
		    </div>
			<input type="hidden" name="liquorId" value="1"> 
<!-- 			value값 수정 필요 -> 바뀐값 전달되야함. -->



			<!-- 별점 드롭다운 메뉴 -->
			<div class="select" data-role="selectBox">
			<!-- 선택된 옵션 값이 출력되는 부분 -->
		        <span date-value="optValue" class="selected-option"></span>


		        <!-- 옵션 영역 -->
		        <input type="hidden" value="" name="boardPoint">
		        <ul class="hide">
		            <li>
		                <div>별점 선택</div>
		            </li>
		            <li>
		                <span class="starContainer">
		                    <i class="fa-solid fa-star-half"></i>
		                </span>
		                <div style="text-align: end; padding-right: 8px;">0.5</div>
		            </li>
		            <li>
		                <span class="starContainer">
		                    <i class="fa-solid fa-star"></i>
		                </span>
		                <div style="text-align: end; padding-right: 8px;">1</div>
		            </li>
		            <li>
		                <span class="starContainer">
		                    <i class="fa-solid fa-star"></i><i class="fa-solid fa-star-half"></i>
		                </span>
		                <div style="text-align: end; padding-right: 8px;">1.5</div>
		            </li>
		            <li>
		                <span class="starContainer">
		                    <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i>
		                </span>
		                <div style="text-align: end; padding-right: 8px;">2</div>
		            </li>
		            <li>
		                <span class="starContainer">
		                    <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star-half"></i>
		                </span>
		                <div style="text-align: end; padding-right: 8px;">2.5</div>
		            </li>
		            <li>
		                <span class="starContainer">
		                    <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i>
		                </span>
		                <div style="text-align: end; padding-right: 8px;">3</div>
		            </li>
		            <li>
		                <span class="starContainer">
		                    <i class="fa-solid fa-star"></i> <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star-half"></i>
		                </span>
		                <div style="text-align: end; padding-right: 8px;">3.5</div>
		            </li>
		            <li>
		                <span class="starContainer">
		                     <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i>
		                </span>
		                <div style="text-align: end; padding-right: 8px;">4</div>
		            </li>
		            <li>
		                <span class="starContainer">
		                     <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star-half"></i>
		                </span>
		                <div style="text-align: end; padding-right: 8px;">4.5</div>
		            </li>
		            <li>
		                <span class="starContainer">
		                     <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i>
		                </span>
		                <div style="text-align: end; padding-right: 8px;">5</div>
		            </li>
		        </ul>
		    </div>
		    썸네일
			<th:block th:if="*{!bFileList.isEmpty()}">
				<div th:each="bFile : ${bFileList}" th:if="${bFile.boardNo == board.boardNo}">
					<a title="다운로드" th:text="${bFile.boardFileRename}" th:href="@{|${bFile.boardFilePath}${bFile.boardFileRename}|}"></a>
					<input type="hidden" name="uploadFileRename" th:value="${bFile.boardFileRename}">
				</div>
			</th:block>		
			<th:block th:if="*{bFileList.isEmpty()}">
				<span>첨부파일 없음</span>
			</th:block>
			<input type="file" name="reloadFile">
		    
			태그 
			<div id="bTagList">
				<span th:each="tag : ${bTagList}" th:if="${tag.boardNo == board.boardNo}">#[[${tag.boardTagName}]] </span>
			</div>
			<input type="text" name="boardTagName" placeholder="#태그"> <br>
			내용 
			<div class="post-form">
				<textarea name="boardContent" id="summernote" th:utext="${board.boardContent}">
				</textarea>
			</div>
			<button>수정</button> 
			<button type="button" onclick="goBack();">취소</button>
		</form>
		
		<script th:inline="javascript">
			/////////////////////////////////////// 태그 js
			const input = document.querySelector('input[name=boardTagName]');
		    let tagify = new Tagify(input); // Tagify 초기화
		    
		    // 태그가 추가되면 이벤트 발생
		    tagify.on('add', function() {
		      console.log(tagify.value); // 입력된 태그 정보 객체(배열)
		      console.log(tagify.value[0].value) // 태그 배열 0번째 객체의 value값 -> 입력한 태그
		    })
		
		
			/////////////////////////////////////// 썸머노트 에디터 구현
			$('#summernote').summernote({
				  // 에디터 크기 설정
				  height: 200,
				  // 에디터 한글 설정
				  lang: 'ko-KR',
				  // 에디터에 커서 이동 (input창의 autofocus라고 생각하시면 됩니다.)
				  toolbar: [
					    // 글자 크기 설정
					    ['fontsize', ['fontsize']],
					    // 글자 [굵게, 기울임, 밑줄, 취소 선, 지우기]
					    ['style', ['bold', 'italic', 'underline','strikethrough', 'clear']],
					    // 글자색 설정
					    ['color', ['color']],
					    // 표 만들기
					    ['table', ['table']],
					    // 서식 [글머리 기호, 번호매기기, 문단정렬]
					    ['para', ['ul', 'ol', 'paragraph']],
					    // 줄간격 설정
					    ['height', ['height']],
					    // 이미지 첨부
					    ['insert',['picture']]
					  ],
					  // 추가한 글꼴
					fontNames: ['Arial', 'Arial Black', 'Comic Sans MS', 'Courier New','맑은 고딕','궁서','굴림체','굴림','돋음체','바탕체'],
					 // 추가한 폰트사이즈
					fontSizes: ['8','9','10','11','12','14','16','18','20','22','24','28','30','36','50','72','96'],
			        // focus는 작성 페이지 접속시 에디터에 커서를 위치하도록 하려면 설정해주세요.
					focus : false,
			        // callbacks은 이미지 업로드 처리입니다.
					callbacks : {                                                    
						onImageUpload : function(files, editor) {   // 매개변수 welEditable 제외시킴.
			                // 다중 이미지 처리를 위해 for문을 사용했습니다.
							for (var i = 0; i < files.length; i++) {
								imageUploader(files[i], this);
							}
						}
					}
			  });
			
			
		
		    
		    
		    //////////////////////////////////////////// 파일 업로드 콜백 함수
		    const imageUploader = (file, el) => {
		    //	FormData()는 브라우저에서 제공하는 API이다.
		    // 이 객체를 사용하면 파일과 같은 바이너리 데이터를 포함하여 다양한 형식의 데이터를 multipart/form-data 형식으로 서버에 전송할 수 있다.
		    	let formData = new FormData();
		    // formData 객체에 데이터를 추가하는 코드이다. append 메서드를 사용하여 키-값 쌍을 FormData 객체에 추가한다.
		    	formData.append('file', file);
		    
		    	$.ajax({
		    		data : formData,
		    		type : "POST",
		    		
		    		// url은 이미지 업로드 컨트롤러 메소드 경로
		    		url : "/board/uploadImage",
		    		
		    		// jQuery가 Content-Type 헤더를 자동으로 설정하지 않게 된다.
		    		// 일반적으로 FormData를 사용해 파일을 업로드할 때는 브라우저가 자동으로 multipart/form-data로 설정하므로 false로 설정한다.
		    		contentType : false,
		    		
		    		// processData 속성을 false로 설정하면 jQuery가 데이터를 쿼리 문자열로 자동으로 변환하지 않는다. 
		    		// FormData 객체를 전송할 때는 processData: false로 설정해야 한다.
		    		processData : false,
		    		
		    		// 인코딩 타입을 multipart/form-data으로 지정해준다. 파일 업로드 시 타입을 이처럼 지정해줘야 한다.
		    		enctype : 'multipart/form-data',
		    		
		    		// 요청이 성공적으로 완료되었을 때 호출되는 콜백 함수이다.
		    		// 서버에서 반환된 데이터를 data 파라미터로 받아 처리할 수 있다.
		    		success : function(data){
		    			console.log(data);
		    			$(el).summernote('insertImage', data, function($image){
		    				$image.css('width', "50%");
		    			});
		    		}
		    		
		    	});
		    }
		    
		    
			//////////////////////////// 별점 선택 드롭다운 js
			
		    const body = document.querySelector('body');
	        const select = document.querySelector(`[data-role="selectBox"]`);
	        const values = select.querySelector(`[date-value="optValue"]`);
	        const option = select.querySelector('ul');
	        const opts = option.querySelectorAll('li');
	        const inputBoardPoint = document.querySelector('input[name="boardPoint"]');
	        

	        /* 셀렉트영역 클릭 시 옵션 숨기기, 보이기 */
	        function selects(e){
	            e.stopPropagation();
	            option.setAttribute('style',`top:${select.offsetHeight}px`)
	            if(option.classList.contains('hide')){
	                option.classList.remove('hide');
	                option.classList.add('show');
	            }else{
	                option.classList.add('hide');
	                option.classList.remove('show');
	            }
	            selectOpt();
	        }

	        /* 옵션선택 */
	        function selectOpt(){
	            opts.forEach(opt=>{
	                const innerValue = opt.innerHTML;
	                function changeValue(){
	                    values.innerHTML = innerValue;
	                    inputBoardPoint.value = values.querySelector('div').innerText;
	                    
	                }
	                opt.addEventListener('click',changeValue)
	            });
	        }

	        /* 렌더링 시 옵션의 첫번째 항목 기본 선택 */
	        function selectFirst(){

			// boardPoint 의 숫자와 div의 contentText의 값과 비교 후 일치하는 항목의 list 의 innerHtml을 초기화
				let i = 0;
				const boardPoint = /*[[${board.boardPoint}]]*/;
				 while (i < opts.length) {
				        // opts[i]에 children[1]이 존재하는지 확인
				        if (opts[i].children.length > 1 && opts[i].children[1].innerHTML == boardPoint) {
				            let firstValue = opts[i].innerHTML;
				            values.innerHTML = `${firstValue}`;
				            inputBoardPoint.value = values.querySelector('div').innerText;
				            break;
				        }
				        i++;
				}
	       }
	        /* 옵션밖의 영역(=바디) 클릭 시 옵션 숨김 */
	        function hideSelect(){
	            if(option.classList.contains('show')){
	                option.classList.add('hide');
	                option.classList.remove('show');
	            }
	        }

	        selectFirst();	// 초기상태 - 목록의 첫 요소 선택
	        select.addEventListener('click',selects); // 클릭 시 selects콜백함수 호출
	        body.addEventListener('click',hideSelect); // body 요소 클릭 시 창 닫힘
		    
	        ////////////////////////////////////////////////////////
	       
	        const liquorSelectBox = document.querySelector('#liquorSelectBox');
	        const modal = document.getElementById("modalWrap");
	        const closeBtn = document.getElementById("closeBtn");
	        
	        liquorSelectBox.addEventListener('click', ()=>{
	        	modal.style.display = "block"; // 버튼을 클릭하면 모달을 보이게 함
	        	
	        });
	        
	        closeBtn.addEventListener('click', ()=>{
	        	modal.style.display = "none"; // 모달을 닫는 버튼(X)을 클릭하면 모달을 숨김
	        });
	        
	        
	        // 모달 - 술 검색창
	        function searchLiquor(){
	        	
	        	$.ajax({})
	        }
	        
	        
	        //취소 - 뒤로가기
	        function goBack(){
	        	history.go(-1);
	        }
	        
	        
</script>
	</body>
</html>